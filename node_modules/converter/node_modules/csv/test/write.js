// Generated by CoffeeScript 1.8.0

/*
Test CSV - Copyright David Worms <open@adaltas.com> (BSD Licensed)
 */

(function() {
  var csv, fs, should;

  fs = require('fs');

  should = require('should');

  csv = process.env.CSV_COV ? require('../lib-cov') : require('../src');

  describe('write', function() {
    it('Test write array', function(next) {
      var count, i, test, _i;
      count = 0;
      test = csv().on('record', function(record, index) {
        record.should.be.an["instanceof"](Array);
        count.should.eql(index);
        return count++;
      }).on('end', function() {
        return count.should.eql(10);
      }).to.string(function(result) {
        result.should.eql("Test 0,0,\"\"\"\"\nTest 1,1,\"\"\"\"\nTest 2,2,\"\"\"\"\nTest 3,3,\"\"\"\"\nTest 4,4,\"\"\"\"\nTest 5,5,\"\"\"\"\nTest 6,6,\"\"\"\"\nTest 7,7,\"\"\"\"\nTest 8,8,\"\"\"\"\nTest 9,9,\"\"\"\"");
        return next();
      });
      for (i = _i = 0; _i < 10; i = ++_i) {
        test.write(["Test " + i, i, '"']);
      }
      return test.end();
    });
    it('Test write object with column options', function(next) {
      var count, i, test, _i;
      count = 0;
      test = csv().on('record', function(record, index) {
        record.should.not.be.an["instanceof"](Array);
        count.should.eql(index);
        return count++;
      }).on('end', function() {
        return count.should.eql(10);
      }).to.string(function(result) {
        result.should.eql("Test 0,0,\"\"\"\"\nTest 1,1,\"\"\"\"\nTest 2,2,\"\"\"\"\nTest 3,3,\"\"\"\"\nTest 4,4,\"\"\"\"\nTest 5,5,\"\"\"\"\nTest 6,6,\"\"\"\"\nTest 7,7,\"\"\"\"\nTest 8,8,\"\"\"\"\nTest 9,9,\"\"\"\"");
        return next();
      }, {
        columns: ['name', 'value', 'escape']
      });
      for (i = _i = 0; _i < 10; i = ++_i) {
        test.write({
          name: "Test " + i,
          value: i,
          escape: '"',
          ovni: "ET " + i
        });
      }
      return test.end();
    });
    it('Test write string', function(next) {
      var buffer, count, i, test, _i;
      count = 0;
      test = csv().on('record', function(record, index) {
        record.should.be.an["instanceof"](Array);
        count.should.eql(index);
        return count++;
      }).on('end', function() {
        return count.should.eql(10);
      }).to.string(function(result) {
        result.should.eql("Test 0,0,\"\"\"\"\nTest 1,1,\"\"\"\"\nTest 2,2,\"\"\"\"\nTest 3,3,\"\"\"\"\nTest 4,4,\"\"\"\"\nTest 5,5,\"\"\"\"\nTest 6,6,\"\"\"\"\nTest 7,7,\"\"\"\"\nTest 8,8,\"\"\"\"\nTest 9,9,\"\"\"\"");
        return next();
      });
      buffer = '';
      for (i = _i = 0; _i < 10; i = ++_i) {
        buffer += ''.concat("Test " + i, ',', i, ',', '""""', "\n");
        if (buffer.length > 250) {
          test.write(buffer.substr(0, 250));
          buffer = buffer.substr(250);
        }
      }
      test.write(buffer);
      return test.end();
    });
    it('Test write string should be preserve', function(next) {
      var buffer, count, i, test, _i;
      count = 0;
      test = csv().transform(function(record, index) {
        if (index === 0) {
          test.write('--------------------\n', true);
        }
        test.write(record);
        test.write('\n--------------------', true);
        record.should.be.an["instanceof"](Array);
        count.should.eql(index);
        count++;
        return null;
      }).to.string(function(result) {
        result.should.eql("# This line should not be parsed\n--------------------\nTest 0,0,\"\"\"\"\n--------------------\nTest 1,1,\"\"\"\"\n--------------------\n# This one as well");
        return next();
      });
      test.write('# This line should not be parsed', true);
      test.write('\n', true);
      buffer = '';
      for (i = _i = 0; _i < 2; i = ++_i) {
        buffer += ''.concat("Test " + i, ',', i, ',', '""""', "\n");
        if (buffer.length > 250) {
          test.write(buffer.substr(0, 250));
          buffer = buffer.substr(250);
        }
      }
      test.write(buffer);
      test.write('\n', true);
      test.write('# This one as well', true);
      return test.end();
    });
    it('should transform record provided by write as an array', function(next) {
      var count, i, test, _i;
      count = 0;
      test = csv().to.path('/dev/null').transform(function(record, index) {
        return count++;
      }).on('close', function() {
        count.should.eql(1000);
        return next();
      });
      for (i = _i = 0; _i < 1000; i = ++_i) {
        test.write(['Test ' + i, i, '"']);
      }
      return test.end();
    });
    it('should emit header even without a source', function(next) {
      var test;
      test = csv().on('end', function(count) {
        return count.should.eql(2);
      }).to.string(function(result) {
        result.should.eql("col1,col2\nfoo1,goo1\nfoo2,goo2");
        return next();
      }, {
        columns: ['col1', 'col2'],
        header: true,
        rowDelimiter: 'unix'
      });
      test.write({
        col1: 'foo1',
        col2: 'goo1'
      });
      test.write({
        col1: 'foo2',
        col2: 'goo2'
      });
      return test.end();
    });
    return it('throw error if not writable', function(next) {
      var test;
      test = csv();
      test.on('error', function(err) {
        err.message.should.eql('CSV no longer writable');
        return next();
      });
      test.write('abc,123');
      test.end();
      return test.write('def,456');
    });
  });

}).call(this);

//# sourceMappingURL=write.js.map
